# yaml-language-server: $schema=https://raw.githubusercontent.com/apache/camel/main/dsl/camel-yaml-dsl/camel-yaml-dsl/src/generated/resources/schema/camelYamlDsl.json

- route:
    id: efecteWebhookController
    from:
      uri: direct:efecteWebhookController
      steps:
        - choice:
            when:
              - simple: ${bean:leaderPodResolver.isLeaderPod()}
                steps:
                  - choice:
                      when:
                        - simple: ${header.Authorization} == 'Bearer {{WEBHOOK_API.TOKEN}}'
                          steps:
                            - log: "{{app.name}} :: Efecte event received"
                            - setProperty:
                                name: datetime
                                simple: ${date-with-timezone:now:Europe/Helsinki:yyyy-MM-dd_HH:mm:ss}
                            - setProperty:
                                name: redisKey
                                simple: "{{app.redis.prefix.request}}${header.datetime}"
                            - bean:
                                ref: redis
                                method: setex(${header.redisKey}, ${body}, {{KEY_EXPIRATION_SECONDS}})
                            - removeHeaders: "*"
                            - setHeader:
                                name: Exchange.HTTP_METHOD
                                constant: POST
                            - setHeader:
                                name: Exchange.HTTP_QUERY
                                constant: bridgeEndpoint=true
                            - log: "{{app.name}} :: forwarding to efecte-iloq-synchronization-integration"
                            - to: "{{INTEGRATION_ENDPOINT}}"
                            - log: "{{app.name}} :: forwarding done, sending response"
                            - setHeader:
                                name: Exchange.HTTP_RESPONSE_CODE
                                constant: "200"
                      otherwise:
                        steps:
                          - log: "{{app.name}} :: webhook controller :: invalid Authentication, token: '${header.Authorization}'"
                          - setHeader:
                              name: CamelHttpResponseCode
                              constant: "401"
